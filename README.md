## PoC - Keycloack with Node.js

### 1 - Start Keycloack Docker

Start the Keycloak Server Docker image.

Ps: To see the Docker image take a look in the Dockerhub - 
https://hub.docker.com/r/jboss/keycloak/
 
```$xslt
docker run -d -p 8080:8080 -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin jboss/keycloak
```

After start the container access: http://localhost:8080/ <br/>
Click in "Administration Console" and put the username and password to execute the login <br/>
User: admin <br/>
Password: admin

### 2 - Realms

Administration console have the feature to create/edit customized Realms. By default exists a realm called "master",
in this example we'll use the default Realm = master 

When the user select the Realm they can configure Users, Roles, Groups, Clients by Realm.


### 3 - Client
To execute this node.js example is necessary create a Client called: *keycloak-test*

#### 3.1 - Create the Client
 - Access the menu "Configure" -> "Clients" and click in the "Create" button.
 - Put the informations: 
    - Client ID: keycloak-test
    - Client Protocol: openid-connect
    - Root URL: http://localhost:3000
 - Click in the "save" button
 
#### 3.2 - Configure the Client
 - Set the informations:
    - Access Type: confidential
    - Service Accounts Enabled: ON
    - Authorization Enabled: ON 

#### 3.3 - Create the Client Role
 - In the tab "Roles" click in the button "Add role"
 - Create a Role called: *staff*
 - Ps: Here we can create the common profiles for the system like "staff", "doctor", "admin", etc.
  
#### 3.4 - Create a Mapper (To get user_name in access token) - not mandatory step
In the JWT generated by Keycloak the user name is returned in a claim called "preferred_username" 
If we need to use Springboot for example, Spring Security OAuth2 Resource expects a claim called "user_name"

To do this kind of customizable Claim, click in the Tab "Mappers" and click in the button "Create"


- Set the data:
    - Name: *Username*
    - Mapper Type: *User Property*
    - Property: *username*
    - Token Claim Name: *user_name*
    - Add to access token: *ON*
- Click in the save button

### 4 - Executing Node.js

Before start the keycloack-test project is necessary go to the KeyCloack Administration Console in the menu
"Clientes" and click in the "keycloak-test". After this click in the tab "Credentials" anc copy the value of a field called
"Secret".
<br/>
```$xslt
Secret: 6c25f74d-3ba2...
```

Execute the git clone of the project:
```$xslt
git clone https://github.com/alvarogomes/keycloack-poc.git
```

Change the attribute "secret" in the file keycloak.json with you copied value.

After this execute: 

```$xslt
yarn install
yarn start
```

The server will start in the port 3000.

<br/>

To test using POSTMAN, import the API calls using this link:
```$xslt
https://www.getpostman.com/collections/68816243f46a54745122
```

Its possible test:
- Signup
- Login
- Secure API

If have any questions please let me know. =]

